## 事务

### MVCC 会加锁吗

MVCC（Multi-Version Concurrency Control，多版本并发控制）是一种数据库并发控制技术，它允许多个事务同时读取数据库的同一部分数据，而不会相互干扰。

在MVCC中，每个事务读取数据的时候会创建一个快照，该快照是在事务开始时创建的数据库的一个副本。因此，即使其他事务对原始数据进行了修改，该事务仍然可以读取快照中的原始数据。当事务提交时，它会将其所做的更改与原始数据进行比较，以确保没有其他事务对数据进行了修改。

在MVCC中，为了保证数据的一致性和隔离性，读取操作和写入操作会相互影响。因此，MVCC会在一定程度上加锁，但与传统的锁机制不同，MVCC并不是通过锁住整个数据表或行来实现并发控制，而是通过在事务中创建快照，并使用版本号来实现并发控制。

当事务提交时，如果其他事务已经对数据做了修改，那么这个事务会检测到这个冲突，会回滚（Rollback）这个事务。这是由数据库的实现来保证的。

在MVCC中，每个事务读取的数据都是快照或历史版本，而不是数据库中的原始数据。当事务提交时，数据库会检查该事务所做的更改与原始数据或快照之间的差异，如果在该事务的执行期间，有其他事务对相同的数据进行了修改，那么该事务会检测到这个冲突，并回滚。

这种回滚操作的发生是由数据库引擎内部实现的，开发人员无需关心具体的实现细节。当一个事务发现有冲突时，数据库会自动回滚该事务并抛出相应的异常，开发人员可以通过捕获这些异常来处理冲突。

总之，在MVCC中，事务提交时会检查其所做的更改与原始数据之间的差异，如果检测到其他事务对相同的数据进行了修改，则该事务会回滚并抛出异常。这种机制可以保证数据的一致性和隔离性，避免了数据竞争的发生。

总之，MVCC采用一种与传统锁机制不同的并发控制方式，不会锁住整个数据表或行，而是通过版本号来实现并发控制。因此，MVCC不会像传统锁机制那样对数据库的性能产生很大的影响。
